<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link href="//fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet">
    <link rel="Stylesheet" type="text/css" href="/css/main.css" />
    <title>Docker</title>

    <style type="text/css">
        .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #24292f;
  background-color: #f6f8fa;
}
.highlight .k, .highlight .kd, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kt, .highlight .kv {
  color: #cf222e;
}
.highlight .gr {
  color: #f6f8fa;
}
.highlight .gd {
  color: #82071e;
  background-color: #ffebe9;
}
.highlight .nb {
  color: #953800;
}
.highlight .nc {
  color: #953800;
}
.highlight .no {
  color: #953800;
}
.highlight .nn {
  color: #953800;
}
.highlight .sr {
  color: #116329;
}
.highlight .na {
  color: #116329;
}
.highlight .nt {
  color: #116329;
}
.highlight .gi {
  color: #116329;
  background-color: #dafbe1;
}
.highlight .ges {
  font-weight: bold;
  font-style: italic;
}
.highlight .kc {
  color: #0550ae;
}
.highlight .l, .highlight .ld, .highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
  color: #0550ae;
}
.highlight .sb {
  color: #0550ae;
}
.highlight .bp {
  color: #0550ae;
}
.highlight .ne {
  color: #0550ae;
}
.highlight .nl {
  color: #0550ae;
}
.highlight .py {
  color: #0550ae;
}
.highlight .nv, .highlight .vc, .highlight .vg, .highlight .vi, .highlight .vm {
  color: #0550ae;
}
.highlight .o, .highlight .ow {
  color: #0550ae;
}
.highlight .gh {
  color: #0550ae;
  font-weight: bold;
}
.highlight .gu {
  color: #0550ae;
  font-weight: bold;
}
.highlight .s, .highlight .sa, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .se, .highlight .sh, .highlight .sx, .highlight .s1, .highlight .ss {
  color: #0a3069;
}
.highlight .nd {
  color: #8250df;
}
.highlight .nf, .highlight .fm {
  color: #8250df;
}
.highlight .err {
  color: #f6f8fa;
  background-color: #82071e;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cp, .highlight .cpf, .highlight .c1, .highlight .cs {
  color: #6e7781;
}
.highlight .gl {
  color: #6e7781;
}
.highlight .gt {
  color: #6e7781;
}
.highlight .ni {
  color: #24292f;
}
.highlight .si {
  color: #24292f;
}
.highlight .ge {
  color: #24292f;
  font-style: italic;
}
.highlight .gs {
  color: #24292f;
  font-weight: bold;
}
      </style>

    <script>

        window.onload = function () {

            // remove vim-wiki generated TOC if it exists
            let h1 = document.evaluate("//h1[text()='Contents']", document).iterateNext();
            if (h1 != null && h1.nextElementSibling.tagName === 'UL') {
                let parent = h1.parentElement;
                parent.removeChild(h1.nextElementSibling);
                parent.removeChild(h1);

                // now generate new TOC
                // function from: https://stackoverflow.com/questions/187619/is-there-a-javascript-solution-to-generating-a-table-of-contents-for-a-page
                var toc = "";
                var level = 0;
                var maxLevel = 6;

                document.getElementById("contents").innerHTML =
                    document.getElementById("contents").innerHTML.replace(
                        /<h([\d])>([^<]+)<\/h([\d])>/gi,
                        function (str, openLevel, titleText, closeLevel) {
                            if (openLevel != closeLevel) {
                                c.log(openLevel)
                                return str + ' - ' + openLevel;
                            }

                            if (openLevel > level) {
                                toc += (new Array(openLevel - level + 1)).join("<ul>");
                            } else if (openLevel < level) {
                                toc += (new Array(level - openLevel + 1)).join("</ul>");
                            }

                            level = parseInt(openLevel);

                            var anchor = titleText.replace(/ /g, "_");
                            toc += "<li><a href=\"#" + anchor + "\">" + titleText
                                + "</a></li>";

                            return "<h" + openLevel + "><a style=\"color: black;\" name=\"" + anchor + "\">"
                                + titleText + "</a></h" + closeLevel + ">";
                        }
                    );

                if (level) {
                    toc += (new Array(level + 1)).join("</ul>");
                }

                document.getElementById("contents").innerHTML = "<h1>Contents</h1>" + toc + document.getElementById("contents").innerHTML;
            }
        };
    </script>

</head>


<body>
    <main class="u-container">

        <header class="c-page__header">
            <p>
                <a style="color: red;" href="./../../index.html">⌂</a> |
                <a href="./../../wikis/">wikis</a> |
                <a href="./index.html">index</a>
                <hr>
            </p>
        </header>


        <div class="c-page">
            <article class="c-article">
                <div class="c-article__main">
                    <article class="c-article">
                        <div class="c-article__main" id="contents">
                            <h1>
<a id="docker" class="anchor" href="#docker" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Docker</h1>
<pre><code>docker logs mycontainer_or_id --since 60m 
</code></pre>
<p>Docker nemá by defualt nastavený žádný logrotate dockeru! To znamená, že po nějaké době dojde na serveru místo. Je třeba na obou serverech nastavit nějaké omezení, na UMAX serveru jsme měli 100m a 5 logů z5. Myslím že si můžeme dovolit nastavit 1g a 5 logů z5 je nutné to ale udělat a to úpravou/vytvořením souboru:
/etc/docker/daemon.json a doplnit následující obsah:</p>
<pre><code>{
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "1g",
        "max-file": "5"
    }
}

sudo systemctl restart docker

docker inspect --format='{{.LogPath}}' api  # log file

docker tag 64af79210286 registry.gitlab.com/$TEAM/$PRJ:master-20210119
docker push !$

docker update --restart=no my-container
docker update --restart=unless-stopped my-container
</code></pre>
<p>set restart policy to no to all running dockers and stop them:</p>
<pre><code>docker update `docker ps -q` --restart no
docker kill `docker ps -q`
</code></pre>
<p>update an image by editing a running container made from it</p>
<pre><code>docker exec -it container-name bash
docker commit container-ID image-name

docker exec -ti influxdb /bin/bash
</code></pre>
<p>recreate and start a new container:</p>
<pre><code>docker-compose stop api
docker-compose create api
docker-compose start api
</code></pre>
<p>backup image</p>
<pre><code>docker inspect 663a995010d6
docker save ad706aa6e03b43d746b9c7f548a77ce5f86e847bced7f96dd578521838a2bc5c &gt; web.docker
</code></pre>
<p>reload environment variables</p>
<pre><code>docker-compose up -d
</code></pre>
<h2>
<a id="basics" class="anchor" href="#basics" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Basics</h2>
<pre><code>sudo usermod -aG docker $USER

docker system prune -a
docker commit $(docker ps -lq) test-image # after changes in an image

docker save ppc &gt; ppc.tar
docker load &lt; ppc.tar

docker build -t ecorp/project/ui .
docker run -p 8081:80 ecorp/project/ui
docker run --env-file ./project.env -p 5001:5000 ecorp/project/api run uwsgi --ini config/project.ini
docker run --env-file ./project.env -p 5000:5000 ecorp/project/api run pipenv run python project.py

docker login --username=uzak
docker push TAG
docker exec -it fc3dbfe13b19 /bin/sh
</code></pre>
<p><a href="http://docker-curriculum.com/">http://docker-curriculum.com/</a></p>
<pre><code>docker run hello-world
docker pull busybox
docker images
docker run busybox ls /etc
docker ps -a
docker run -it busybox sh
docker rm $(docker ps -a -q -f status=exited)
docker rmi 
docker run prakhar1989/static-site
docker run -d -P --name static-site prakhar1989/static-site
docker port static-site
docker run -p 8888:80 prakhar1989/static-site
docker stop 082865c5dc79
docker container rm 082865c5dc79
docker container ls
</code></pre>
<h2>
<a id="images" class="anchor" href="#images" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Images</h2>
<pre><code>docker images
docker pull ubuntu:12.04
docker search
</code></pre>
<h2>
<a id="dockerfile-example" class="anchor" href="#dockerfile-example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dockerfile example</h2>
<pre><code>FROM ubuntu:14.04
MAINTAINER MU &lt;uzak+git@mailbox.org&gt;
RUN apt-get -yqq update
RUN apt-get -yqq python-pip python-dev nodejs npm
RUN ln -s /usr/bin/nodejs /usr/bin/node
ADD flask-app /opt/flask-app
WORKDIR /opt/flask-app
RUN npm install
RUN npm run build
RUN pip install -r requirements.txt
EXPOSE 5000
CMD ["python", "./app.py"]

docker build -t uzak/catnip .
docker run -p 8888:5000 uzak/catnip
docker login
docker push uzak/catnip
</code></pre>
<h2>
<a id="multicontainer-setup" class="anchor" href="#multicontainer-setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Multicontainer setup</h2>
<pre><code>docker search elasticsearch
docker network ls
docker network inspect bridge
docker run -it --rm prakhar1989/foodtrucks-web bash
docker network create foodtrucks
docker ps
docker stop 5d04018ed570
docker run -dp 9200:9200 --net foodtrucks --name es elasticsearch
docker run -it --rm --net foodtrucks  prakhar1989/foodtrucks-web bash
docker run -d --net foodtrucks -p 5000:5000 --name foodtrucks-web prakhar1989/foodtrucks-web
</code></pre>
<h2>
<a id="docker-compose" class="anchor" href="#docker-compose" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>docker-compose</h2>
<pre><code>version: "2"
services:
    es:
        image: elasticsearch
    web:
        image: prakhar1989/foodtrucks-web
        command: python app.py
        ports:
            - "5000:5000"
        volumes:
            - .:/code

docker stop $(docker ps -q)
docker-compose up
docker-compose up -d
docker-compose restart
</code></pre>
<h2>
<a id="troubleshooting" class="anchor" href="#troubleshooting" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Troubleshooting</h2>
<ul>
<li>
<p>Permission denied on host directory: <a href="https://stackoverflow.com/questions/24288616/permission-denied-on-accessing-host-directory-in-docker">https://stackoverflow.com/questions/24288616/permission-denied-on-accessing-host-directory-in-docker</a></p>
</li>
<li>
<p>CentOS doesn't allow access from containers to the host by default: <a href="https://forums.docker.com/t/no-route-to-host-network-request-from-container-to-host-ip-port-published-from-other-container/39063/5">solution</a></p>
<p>docker rm $(docker ps -a -f status=exited -q) # remove exited containers
docker rmi $(docker images -qa)            # remove all images</p>
</li>
</ul>
<h2>
<a id="links" class="anchor" href="#links" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Links</h2>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-18-04">Setup a private docker registry</a></p>

                        </div>
                    </article>

                </div>
            </article>
    </main>
</body>

</html>
