<!doctype html>
<html amp lang="en">
  <head>
    <meta charset="utf-8">
    <title>Kubernetes</title>
    <link rel="canonical" href="https://uzak.github.io/2021/02/kubernetes" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese">
    <style amp-custom>
    *{margin:0;padding:0}*,*:before,*:after{box-sizing:inherit}html{min-height:100%;box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-size:62.5%}body{font-family:'Inconsolata', monospace;font-weight:400;-webkit-font-smoothing:antialiased}article,aside,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}h1,h2,h3,h4,h5,h6{font-weight:400;color:#163541}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}img{max-width:100%;font-style:italic;vertical-align:middle;border:0}svg:not(:root){overflow:hidden}svg{pointer-events:none;max-height:100%}a{background-color:transparent;text-decoration:none;color:#0067FB}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}i,em{font-weight:italic}figure{margin:0}hr{margin-top:2.5rem;margin-bottom:2.5rem;width:100%;height:1px;border:0;background:#EFF1F3}pre{overflow:auto}.u-container{max-width:62rem;margin-right:auto;margin-left:auto;padding-top:10rem;padding-right:1rem;padding-left:1rem}.u-separate{margin-right:.45rem;margin-left:.25rem;color:#5C6E74}.u-separate:after{content:'\00a0/'}.c-page__header{margin-bottom:10rem}.c-page__header h1{margin-bottom:2.5rem;line-height:1.5;font-size:2.4rem;color:#163541}.c-page__header p{line-height:1;font-size:1.8rem}.c-page__footer{margin-bottom:10rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:center;-webkit-align-items:center;-ms-flex-align:center;align-items:center}.c-page__footer p{line-height:1.5;font-size:1.8rem;color:#5C6E74}.c-article{margin-bottom:10rem}.c-article__header{margin-bottom:5rem}@media screen and (min-width: 45rem){.c-article__header{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:baseline;-webkit-align-items:baseline;-ms-flex-align:baseline;align-items:baseline}}.c-article__title{line-height:1.5;font-size:3.2rem;color:#163541}.c-article__time{line-height:1.5;font-size:1.8rem;color:#5C6E74}.c-article__main{margin-bottom:5rem;line-height:1.5;font-size:1.8rem;color:#5C6E74}.c-article__main>*{margin-bottom:1.8rem}.c-article__main h2{line-height:1.5;font-size:2.4rem}.c-article__main h3{line-height:1.5;font-size:2rem}.c-article__main h4{line-height:1.6;font-size:1.8rem}.c-article__main h5{line-height:1.5;font-size:1.8rem}.c-article__main strong{color:#163541;font-weight:400}.c-article__main blockquote{margin-left:0;margin-right:0;padding-left:1.8rem;border-left:1px solid #EFF1F3}.c-article__main ul,.c-article__main ol{margin-left:2.1rem}.c-tag{margin-right:1rem;position:relative;white-space:nowrap;line-height:1.5;font-size:1.8rem;color:#163541}.c-tag:before{color:#869395;content:'#\2009'}.c-archives{margin-bottom:10rem}.c-archives__year{margin-bottom:2.5rem;line-height:1.5;font-size:3.2rem}.c-archives__list{margin-bottom:2.5rem;list-style:none}.c-archives__item{padding-top:2.5rem;padding-bottom:2.5rem;border-top:1px solid #EFF1F3}@media screen and (min-width: 45rem){.c-archives__item{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:center;-webkit-align-items:center;-ms-flex-align:center;align-items:center}}.c-archives__item h3{line-height:1.5;font-size:1.8rem}.c-archives__item p{line-height:1.5;font-size:1.8rem;color:#515862}pre,code{font-family:'Inconsolata', monospace;font-size:1.4rem;line-height:1.5}.highlight{border-radius:4px;background:#FDFDFD;border:1px solid #E8E8EB;color:#93a1a1}.highlight .gutter{padding:1.2rem;border-right:1px solid #E8E8EB}.highlight .code{padding:1.2rem}span.lineno{padding:1rem;border-right:1px solid #E8E8EB}.highlight .c{color:#586e75}.highlight .err{color:#93a1a1}.highlight .g{color:#93a1a1}.highlight .k{color:#859900}.highlight .l{color:#93a1a1}.highlight .n{color:#93a1a1}.highlight .o{color:#859900}.highlight .x{color:#cb4b16}.highlight .p{color:#93a1a1}.highlight .cm{color:#586e75}.highlight .cp{color:#859900}.highlight .c1{color:#586e75}.highlight .cs{color:#859900}.highlight .gd{color:#2aa198}.highlight .ge{color:#93a1a1;font-style:italic}.highlight .gr{color:#dc322f}.highlight .gh{color:#cb4b16}.highlight .gi{color:#859900}.highlight .go{color:#93a1a1}.highlight .gp{color:#93a1a1}.highlight .gs{color:#93a1a1;font-weight:bold}.highlight .gu{color:#cb4b16}.highlight .gt{color:#93a1a1}.highlight .kc{color:#cb4b16}.highlight .kd{color:#268bd2}.highlight .kn{color:#859900}.highlight .kp{color:#859900}.highlight .kr{color:#268bd2}.highlight .kt{color:#dc322f}.highlight .ld{color:#93a1a1}.highlight .m{color:#2aa198}.highlight .s{color:#2aa198}.highlight .na{color:#93a1a1}.highlight .nb{color:#B58900}.highlight .nc{color:#268bd2}.highlight .no{color:#cb4b16}.highlight .nd{color:#268bd2}.highlight .ni{color:#cb4b16}.highlight .ne{color:#cb4b16}.highlight .nf{color:#268bd2}.highlight .nl{color:#93a1a1}.highlight .nn{color:#93a1a1}.highlight .nx{color:#93a1a1}.highlight .py{color:#93a1a1}.highlight .nt{color:#268bd2}.highlight .nv{color:#268bd2}.highlight .ow{color:#859900}.highlight .w{color:#93a1a1}.highlight .mf{color:#2aa198}.highlight .mh{color:#2aa198}.highlight .mi{color:#2aa198}.highlight .mo{color:#2aa198}.highlight .sb{color:#586e75}.highlight .sc{color:#2aa198}.highlight .sd{color:#93a1a1}.highlight .s2{color:#2aa198}.highlight .se{color:#cb4b16}.highlight .sh{color:#93a1a1}.highlight .si{color:#2aa198}.highlight .sx{color:#2aa198}.highlight .sr{color:#dc322f}.highlight .s1{color:#2aa198}.highlight .ss{color:#2aa198}.highlight .bp{color:#268bd2}.highlight .vc{color:#268bd2}.highlight .vg{color:#268bd2}.highlight .vi{color:#268bd2}.highlight .il{color:#2aa198}
    </style>
    
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <main class="u-container">
      <div class="c-page">
        <article class="c-article">
          <header class="c-page__header">
            <h1>अहो अहं
</h1>
            <p><a href="/">&lt;&ndash;&ndash; Back</a></p>
          </header>
          <div class="c-article__main">
            <header class="c-article__header">
              <h1 class="c-article__title">Kubernetes</h1>
              <p class="c-article__time"><time datetime="2021-02-22T00:00:00+01:00" itemprop="datePublished">Feb 22, 2021</time></p>
            </header>
            <p>Table of contents:</p>
<ul id="markdown-toc">
  <li><a href="#install-and-deploy" id="markdown-toc-install-and-deploy">Install and Deploy</a></li>
  <li><a href="#namespaces" id="markdown-toc-namespaces">Namespaces</a></li>
  <li>
<a href="#pods" id="markdown-toc-pods">Pods</a>    <ul>
      <li><a href="#multi-container-pods-use-cases" id="markdown-toc-multi-container-pods-use-cases">multi-container Pods use-cases</a></li>
      <li><a href="#jobs" id="markdown-toc-jobs">Jobs</a></li>
    </ul>
  </li>
  <li><a href="#init-containers" id="markdown-toc-init-containers">Init containers</a></li>
  <li><a href="#rolling-updates" id="markdown-toc-rolling-updates">Rolling Updates</a></li>
  <li><a href="#labels" id="markdown-toc-labels">Labels</a></li>
  <li>
<a href="#replication-controller-and-replica-sets" id="markdown-toc-replication-controller-and-replica-sets">Replication Controller and Replica Sets</a>    <ul>
      <li><a href="#replicasets" id="markdown-toc-replicasets">ReplicaSets</a></li>
    </ul>
  </li>
  <li><a href="#kubernetes-services" id="markdown-toc-kubernetes-services">Kubernetes Services</a></li>
  <li><a href="#daemonsets" id="markdown-toc-daemonsets">DaemonSets</a></li>
  <li><a href="#scheduling-jobs" id="markdown-toc-scheduling-jobs">Scheduling Jobs</a></li>
  <li>
<a href="#volumes" id="markdown-toc-volumes">Volumes</a>    <ul>
      <li><a href="#nfs" id="markdown-toc-nfs">NFS</a></li>
      <li>
<a href="#persistent-volumes" id="markdown-toc-persistent-volumes">Persistent Volumes</a>        <ul>
          <li>
<a href="#persistentvolumeclaim" id="markdown-toc-persistentvolumeclaim">PersistentVolumeClaim</a>            <ul>
              <li><a href="#using-a-persistentvolumeclaim-in-a-pod" id="markdown-toc-using-a-persistentvolumeclaim-in-a-pod">Using a PersistentVolumeClaim in a Pod</a></li>
              <li><a href="#local-persistent-volumes-with-storageclass" id="markdown-toc-local-persistent-volumes-with-storageclass">Local Persistent Volumes with StorageClass</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#configmaps" id="markdown-toc-configmaps">ConfigMaps</a></li>
      <li><a href="#kubernetes-secrets" id="markdown-toc-kubernetes-secrets">Kubernetes Secrets</a></li>
    </ul>
  </li>
  <li><a href="#stateful-sets" id="markdown-toc-stateful-sets">Stateful sets</a></li>
  <li>
<a href="#k8s-api-server" id="markdown-toc-k8s-api-server">K8s API Server</a>    <ul>
      <li><a href="#service-account--roles" id="markdown-toc-service-account--roles">Service Account + Roles</a></li>
      <li><a href="#containers-security-context" id="markdown-toc-containers-security-context">Container’s Security Context</a></li>
      <li><a href="#configure-containers-security-context" id="markdown-toc-configure-containers-security-context">Configure container’s security context</a></li>
      <li><a href="#individual-capabilities" id="markdown-toc-individual-capabilities">Individual Capabilities</a></li>
    </ul>
  </li>
  <li><a href="#authentication" id="markdown-toc-authentication">Authentication</a></li>
  <li>
<a href="#authorization" id="markdown-toc-authorization">Authorization</a>    <ul>
      <li><a href="#rbac" id="markdown-toc-rbac">RBAC</a></li>
    </ul>
  </li>
  <li>
<a href="#limit-resources" id="markdown-toc-limit-resources">Limit Resources</a>    <ul>
      <li><a href="#resource-quota-types" id="markdown-toc-resource-quota-types">Resource quota types</a></li>
      <li><a href="#limit-range" id="markdown-toc-limit-range">Limit Range</a></li>
      <li><a href="#limiting-resources" id="markdown-toc-limiting-resources">Limiting resources</a></li>
    </ul>
  </li>
  <li>
<a href="#expose-containers-to-external-networks" id="markdown-toc-expose-containers-to-external-networks">Expose containers to external networks</a>    <ul>
      <li><a href="#kubectl-port-forwarding" id="markdown-toc-kubectl-port-forwarding">kubectl port forwarding</a></li>
      <li><a href="#kubectl-expose" id="markdown-toc-kubectl-expose">kubectl expose</a></li>
      <li>
<a href="#ingress" id="markdown-toc-ingress">Ingress</a>        <ul>
          <li><a href="#configure-ingress-using-host" id="markdown-toc-configure-ingress-using-host">Configure Ingress using Host</a></li>
          <li><a href="#configure-ingress-using-path" id="markdown-toc-configure-ingress-using-path">Configure Ingress using Path</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><a href="https://www.golinuxcloud.com/kubernetes-tutorial/">source</a></p>

<h1 id="install-and-deploy">Install and Deploy</h1>

<ul>
  <li>install kubectl</li>
  <li>install minikube</li>
</ul>

<p>Commands:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">minikube</span> <span class="n">start</span>  
<span class="n">minikube</span> <span class="n">status</span>

<span class="n">kubectl</span> <span class="n">get</span> <span class="n">node</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span>

<span class="n">kubectl</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">hello</span><span class="o">-</span><span class="n">minikube</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">echoserver</span><span class="p">:</span><span class="mf">1.4</span>
<span class="n">kubectl</span> <span class="n">expose</span> <span class="n">deployment</span> <span class="n">hello</span><span class="o">-</span><span class="n">minikube</span> <span class="o">--</span><span class="nb">type</span><span class="o">=</span><span class="n">NodePort</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span>
<span class="n">minikube</span> <span class="n">service</span> <span class="n">hello</span><span class="o">-</span><span class="n">minikube</span> <span class="o">--</span><span class="n">url</span>
<span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="p">.</span><span class="mf">49.2</span><span class="p">:</span><span class="mi">31223</span>
<span class="n">kubectl</span> <span class="n">delete</span> <span class="n">deployments</span><span class="p">.</span><span class="n">apps</span> <span class="n">hello</span><span class="o">-</span><span class="n">minikube</span> 

<span class="n">minikube</span> <span class="n">pause</span>
<span class="n">minikube</span> <span class="n">unpause</span>
<span class="n">minikube</span> <span class="n">stop</span>
</code></pre></div></div>

<h1 id="namespaces">Namespaces</h1>

<ul>
  <li>for organization and resource separation</li>
  <li>
<code class="language-python highlighter-rouge"><span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">mystuff</span></code> or <code class="language-python highlighter-rouge"><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span><span class="o">=</span><span class="n">mystuff</span></code>
</li>
  <li><code class="language-python highlighter-rouge"><span class="n">kubectl</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span></code></li>
</ul>

<p>Default namespaces for new clusters:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">ns</span>  
<span class="n">NAME</span>              <span class="n">STATUS</span>   <span class="n">AGE</span>
<span class="n">default</span>           <span class="n">Active</span>   <span class="mi">13</span><span class="n">m</span>      <span class="c1"># k8s resources are crated here by default
</span><span class="n">kube</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">lease</span>   <span class="n">Active</span>   <span class="mi">13</span><span class="n">m</span>      <span class="c1"># storage for node lease information
</span><span class="n">kube</span><span class="o">-</span><span class="n">public</span>       <span class="n">Active</span>   <span class="mi">13</span><span class="n">m</span>      <span class="c1"># world-readable
</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span>       <span class="n">Active</span>   <span class="mi">13</span><span class="n">m</span>      <span class="c1"># infrastructure pods
</span></code></pre></div></div>

<p>Commands:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span> <span class="n">get</span> <span class="nb">all</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span>    <span class="c1"># all objects in all ns
</span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">default</span>         <span class="c1"># all pods in default ns
</span><span class="n">kubectl</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iE</span> <span class="s">'namespace|KIND'</span>  <span class="c1"># get res name: Namespace
</span><span class="n">kubectl</span> <span class="n">explain</span> <span class="n">Namespace</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>              <span class="c1"># get its version
</span>
<span class="c1"># create app-ns.yml
</span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">app</span><span class="o">-</span><span class="n">ns</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">ns</span> <span class="n">dev</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">ns</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">ns</span> <span class="n">dev</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">ns</span> <span class="n">default</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span>

<span class="c1"># create nginx-app.yml
</span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">app</span><span class="p">.</span><span class="n">yml</span>

<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">default</span> <span class="n">nginx</span><span class="o">-</span><span class="n">app</span>   <span class="c1"># not found
</span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">app</span> <span class="n">nginx</span><span class="o">-</span><span class="n">app</span>       <span class="c1"># found
</span>
<span class="n">kubectl</span> <span class="n">delete</span> <span class="n">ns</span> <span class="n">dev</span>                       <span class="c1"># delete everything in a ns incl. 
</span><span class="n">kubectl</span> <span class="n">delete</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">app</span> <span class="o">--</span><span class="nb">all</span>            <span class="c1"># keep namespace, delete all pods
</span><span class="n">kubectl</span> <span class="n">delete</span> <span class="nb">all</span> <span class="o">-</span><span class="n">n</span> <span class="n">app</span> <span class="o">--</span><span class="nb">all</span>             <span class="c1"># delete all
</span></code></pre></div></div>

<h1 id="pods">Pods</h1>

<ul>
  <li>declarative way: uses yaml files, like nginx-app.yml above</li>
  <li>imperative way: uses <code class="language-python highlighter-rouge"><span class="n">kubectl</span></code>
</li>
  <li>a pod contains containers. Usually one. If a pod has more than one containers, they are always executed on a single worker, never span to multiple workers.</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="p">.</span><span class="n">yml</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">nginx</span>          <span class="c1"># shows the node
</span><span class="n">docker</span> <span class="n">ps</span>                           <span class="c1"># get status on the node
</span><span class="n">kubectl</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">nginx</span> <span class="o">-</span><span class="n">c</span> <span class="n">nginx</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>    

<span class="n">kubectl</span> <span class="n">port</span><span class="o">-</span><span class="n">forward</span> <span class="n">nginx</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">80</span> 
</code></pre></div></div>

<h2 id="multi-container-pods-use-cases">multi-container Pods use-cases</h2>
<ul>
  <li>
<strong>sidecar container</strong>: enhances primary app, e.g. logging. Both are closely related.</li>
  <li>ambassador container: a container represents a primary container for outside e.g. proxy</li>
  <li>adapter container: to adapt/normalize traffic for other apps inside</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create create-sidecar.yml
</span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">create</span><span class="o">-</span><span class="n">sidecar</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>

<span class="err">$</span> <span class="n">kubectl</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">sidecar</span><span class="o">-</span><span class="n">pod</span> <span class="o">-</span><span class="n">c</span> <span class="n">sidecar</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">sidecar</span><span class="o">-</span><span class="n">pod</span> <span class="o">/</span><span class="p">]</span><span class="c1"># curl http://localhost/date.txt
</span><span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">05</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">15</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">25</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">35</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">45</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">55</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">05</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">15</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">25</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">35</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="n">Sun</span> <span class="n">Feb</span> <span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">45</span> <span class="n">UTC</span> <span class="mi">2021</span>
<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">sidecar</span><span class="o">-</span><span class="n">pod</span> <span class="o">/</span><span class="p">]</span><span class="c1"># 
</span>
<span class="n">kubectl</span> <span class="n">logs</span> <span class="n">sidecar</span><span class="o">-</span><span class="n">pod</span> <span class="n">sidecar</span>    <span class="c1"># show logs
</span><span class="n">kubectl</span> <span class="n">delete</span> <span class="n">pod</span> <span class="n">nginx</span>
</code></pre></div></div>

<h2 id="jobs">Jobs</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">completitions</span><span class="o">=</span><span class="n">m</span>         <span class="c1"># stop after `m`
</span><span class="n">parallelism</span><span class="o">=</span><span class="n">n</span>           <span class="c1"># `n` jobs are started
</span></code></pre></div></div>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span> <span class="n">explain</span> <span class="n">Job</span>

<span class="c1"># create k8s/pod-simple-job.yml
</span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">k8s</span><span class="o">/</span><span class="n">pod</span><span class="o">-</span><span class="n">simple</span><span class="o">-</span><span class="n">job</span><span class="p">.</span><span class="n">yml</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span>        <span class="c1"># each execution will add one more pod
</span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">jobs</span>        
<span class="n">kubectl</span> <span class="n">delete</span> <span class="n">job</span> <span class="n">pod</span><span class="o">-</span><span class="n">simple</span><span class="o">-</span><span class="n">job</span>
</code></pre></div></div>

<p><code class="language-python highlighter-rouge"><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">activeDeadlineSeconds</span></code> to set an execution deadline no matter how many pods are created.</p>

<h1 id="init-containers">Init containers</h1>

<ul>
  <li>run in the same pod as main container</li>
  <li>to complete a task before the regular container is started</li>
  <li>if a pod restarts, all init containers are executed again</li>
</ul>

<p>Example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">cat</span> <span class="n">pod</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">container</span><span class="p">.</span><span class="n">yml</span>
<span class="p">...</span>

<span class="err">$</span> <span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">container</span><span class="p">.</span><span class="n">yml</span> 

<span class="err">$</span> <span class="n">k</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">NAME</span>                       <span class="n">READY</span>   <span class="n">STATUS</span>     <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">init</span><span class="o">-</span><span class="n">container</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="mi">1</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Init</span><span class="p">:</span><span class="mi">0</span><span class="o">/</span><span class="mi">1</span>   <span class="mi">0</span>          <span class="mi">58</span><span class="n">s</span>
</code></pre></div></div>

<h1 id="rolling-updates">Rolling Updates</h1>
<ul>
  <li>A <code class="language-python highlighter-rouge"><span class="n">Replica</span> <span class="n">Set</span></code> manages pods. A <code class="language-python highlighter-rouge"><span class="n">Deployment</span></code> manages a <code class="language-python highlighter-rouge"><span class="n">Replica</span> <span class="n">Set</span></code>.</li>
  <li>property: <code class="language-python highlighter-rouge"><span class="n">minReadySeconds</span></code> how long the pod should be ready before it is treated as available. Until it is available, the rollout will not continue.</li>
  <li>
<code class="language-python highlighter-rouge"><span class="n">maxSurge</span></code> - max number of pods that can be created over the desired  number of <code class="language-python highlighter-rouge"><span class="n">ReplicaSet</span></code> before updating</li>
  <li>
<code class="language-python highlighter-rouge"><span class="n">maxUnavailable</span></code> - max number of pods that can be unavailable during rollout</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deploy</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">nginx</span> <span class="o">--</span><span class="n">dry</span><span class="o">-</span><span class="n">run</span><span class="o">=</span><span class="n">client</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span> <span class="o">&gt;</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deploy</span><span class="p">.</span><span class="n">yml</span>
<span class="c1"># adapt nginx-deploy.yml
</span>
<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deploy</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">deployments</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">rs</span>            <span class="c1"># replica set
</span>
<span class="c1"># rolling deployment example
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">deployments</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">event</span> <span class="o">--</span><span class="n">field</span><span class="o">-</span><span class="n">selector</span> <span class="n">involvedObject</span><span class="p">.</span><span class="n">name</span><span class="o">=</span><span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="mi">74</span><span class="n">cf96d8bb</span><span class="o">-</span><span class="n">bn9jq</span>     <span class="c1"># filter for pecific pod
</span>
<span class="n">k</span> <span class="n">rollout</span> <span class="n">history</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span>  <span class="c1"># show rollout history (no record)
</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">deployments</span><span class="p">.</span><span class="n">apps</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span> 

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span><span class="p">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">record</span>                          <span class="c1"># add change cause to history
</span><span class="n">k</span> <span class="nb">set</span> <span class="n">image</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span> <span class="n">nginx</span><span class="o">=</span><span class="n">nginx</span><span class="p">:</span><span class="mf">1.15</span> <span class="o">--</span><span class="n">record</span>  <span class="c1"># changes will be recorded
</span>
<span class="n">kubectl</span> <span class="nb">set</span> <span class="n">image</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span> <span class="n">nginx</span><span class="o">=</span><span class="n">nginx</span><span class="p">:</span><span class="mf">1.15</span> <span class="o">--</span><span class="n">record</span>

<span class="n">k</span> <span class="n">rollout</span> <span class="n">status</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span>                       <span class="c1"># status of deployment
</span>
<span class="c1"># pause and resume deployment
</span><span class="err">$</span> <span class="n">k</span> <span class="nb">set</span> <span class="n">image</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span> <span class="n">nginx</span><span class="o">=</span><span class="n">nginx</span><span class="p">:</span><span class="mf">1.16</span> <span class="o">--</span><span class="n">record</span>
<span class="err">$</span> <span class="n">k</span> <span class="n">rollout</span> <span class="n">pause</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span>
<span class="err">$</span> <span class="n">k</span> <span class="n">rollout</span> <span class="n">status</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span>
<span class="n">Waiting</span> <span class="k">for</span> <span class="n">deployment</span> <span class="s">"rolling-nginx"</span> <span class="n">rollout</span> <span class="n">to</span> <span class="n">finish</span><span class="p">:</span> <span class="mi">2</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">4</span> <span class="n">new</span> <span class="n">replicas</span> <span class="n">have</span> <span class="n">been</span> <span class="n">updated</span><span class="p">...</span>
<span class="err">$</span> <span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">l</span> <span class="n">app</span><span class="o">=</span><span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span>
<span class="n">NAME</span>                             <span class="n">READY</span>   <span class="n">STATUS</span>              <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="mi">74</span><span class="n">cf96d8bb</span><span class="o">-</span><span class="mi">4</span><span class="n">pbs2</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">88</span><span class="n">s</span>
<span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="mi">74</span><span class="n">cf96d8bb</span><span class="o">-</span><span class="mi">8</span><span class="n">t2gf</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">90</span><span class="n">s</span>
<span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="mi">74</span><span class="n">cf96d8bb</span><span class="o">-</span><span class="n">jklcv</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">90</span><span class="n">s</span>
<span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="mi">765</span><span class="n">c4fc67d</span><span class="o">-</span><span class="n">dfqgs</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">20</span><span class="n">s</span>
<span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="mi">765</span><span class="n">c4fc67d</span><span class="o">-</span><span class="n">nm5sr</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">20</span><span class="n">s</span>
<span class="err">$</span> <span class="n">kubectl</span> <span class="n">rollout</span> <span class="n">resume</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span>

<span class="c1"># rollback
</span><span class="err">$</span> <span class="n">k</span> <span class="n">rollout</span> <span class="n">undo</span> <span class="n">deployment</span> <span class="n">rolling</span><span class="o">-</span><span class="n">nginx</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">revision</span><span class="o">=</span><span class="mi">2</span>
</code></pre></div></div>

<h1 id="labels">Labels</h1>
<ul>
  <li>
<strong>key: value</strong> pairs for categorization.</li>
  <li>Annotations are labels that won’t need to be queried against.</li>
</ul>

<p>Selectors:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tier</span> <span class="o">=</span> <span class="n">frontend</span>
<span class="n">tier</span> <span class="o">!=</span> <span class="n">frontend</span>
<span class="n">tier</span> <span class="o">!=</span> <span class="n">frontend</span><span class="p">,</span> <span class="n">game</span> <span class="o">=</span> <span class="nb">super</span><span class="o">-</span><span class="n">shooter</span><span class="o">-</span><span class="mi">2</span>

<span class="n">environment</span> <span class="ow">in</span> <span class="p">(</span><span class="n">production</span><span class="p">,</span> <span class="n">qa</span><span class="p">)</span>
<span class="n">tier</span> <span class="n">notin</span> <span class="p">(</span><span class="n">frontend</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
<span class="n">partition</span>  <span class="c1"># all pods that have partition label - no mater what value
</span>
<span class="n">env</span> <span class="ow">in</span> <span class="p">(</span><span class="n">prod</span><span class="p">,</span> <span class="n">qa</span><span class="p">),</span> <span class="n">tier</span> <span class="n">notin</span> <span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">be</span><span class="p">),</span> <span class="n">partition</span>   <span class="c1"># joining
</span></code></pre></div></div>

<p>kubectl examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Assign labels while creating new objects
</span><span class="n">k</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">label</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">example</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">nginx</span> <span class="o">--</span><span class="n">dry</span><span class="o">-</span><span class="n">run</span><span class="o">=</span><span class="n">client</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span> <span class="o">&gt;</span> <span class="n">label</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">example</span><span class="p">.</span><span class="n">yml</span>
<span class="c1"># edit the file
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">label</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">example</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">deployments</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">labels</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">labels</span> 

<span class="c1"># Assign new label to existing pod runtime as patch
</span><span class="n">k</span> <span class="n">patch</span> <span class="n">deployment</span> <span class="n">label</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">example</span> <span class="o">--</span><span class="n">patch</span> <span class="s">"$(cat update-label.yml)"</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">deployment</span> <span class="n">label</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">example</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">labels</span> 

<span class="c1"># Assign a new label to existing deployments using kubectl
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deploy</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">deployments</span><span class="p">.</span><span class="n">apps</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">labels</span> 
<span class="n">k</span> <span class="n">label</span> <span class="n">deployment</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deploy</span> <span class="n">tier</span><span class="o">=</span><span class="n">backend</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">deployments</span><span class="p">.</span><span class="n">apps</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">labels</span>    <span class="c1"># `tier` added for nginx-deploy
</span>
<span class="c1"># List resource objects
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="n">selector</span> <span class="s">'app=prod'</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="n">selector</span> <span class="s">'app=dev'</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">deployment</span> <span class="o">--</span><span class="n">selector</span> <span class="s">"app in (prod, dev)"</span>

<span class="c1"># Removing labels
</span><span class="n">k</span> <span class="n">label</span> <span class="n">deployment</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deploy</span> <span class="nb">type</span><span class="o">-</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">deployments</span><span class="p">.</span><span class="n">apps</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">labels</span>             
</code></pre></div></div>

<h1 id="replication-controller-and-replica-sets">Replication Controller and Replica Sets</h1>
<ul>
  <li>A replication controller is a k8s resource that ensures that its pods are always running.</li>
  <li><strong>It ensures that exact number of pods always matches its label selector.</strong></li>
  <li>If a Node is out of resources for creating new pods, it will automatically create new one on another available cluster node.</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create replication-controller.yml
</span><span class="n">kubectl</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iE</span> <span class="s">'KIND|replication'</span>
<span class="n">kubectl</span> <span class="n">explain</span> <span class="n">ReplicationController</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n2</span>    <span class="c1"># find out version
</span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">replication</span><span class="o">-</span><span class="n">controller</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span>            <span class="c1"># three new pods
</span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">rc</span>              <span class="c1"># status and list of available rc
</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">pod</span> <span class="n">myapp</span><span class="o">-</span><span class="n">rc</span><span class="o">-</span><span class="n">mgztn</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span>                  <span class="c1"># one is new
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">rc</span> <span class="n">myapp</span><span class="o">-</span><span class="n">rc</span>

<span class="c1"># changing the pod template will affect only newly created pods
</span><span class="n">k</span> <span class="n">edit</span> <span class="n">rc</span> <span class="n">myapp</span><span class="o">-</span><span class="n">rc</span>      <span class="c1"># reduce replicas to 2
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pods</span>              <span class="c1"># one is terminating
</span><span class="n">k</span> <span class="n">get</span> <span class="n">rc</span>                <span class="c1"># display status
</span>
<span class="n">k</span> <span class="n">scale</span> <span class="n">rc</span> <span class="n">myapp</span><span class="o">-</span><span class="n">rc</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">6</span>        <span class="c1"># horizontal scaling
</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">rc</span> <span class="n">myapp</span><span class="o">-</span><span class="n">rc</span> <span class="o">--</span><span class="n">cascade</span><span class="o">=</span><span class="n">false</span>    <span class="c1"># to keep its pods running
</span></code></pre></div></div>

<h2 id="replicasets">ReplicaSets</h2>

<ul>
  <li>ReplicaSet deprecates ReplicationController. It has more expressive pod selectors. It can match pods lacking a certain selector or just having a key regardless of the value.</li>
  <li>Pods aren’t owned by RC/RS and can be moved between them if necessary.</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iE</span> <span class="s">'KIND|replica'</span>
<span class="n">k</span> <span class="n">explain</span> <span class="n">ReplicaSet</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>

<span class="n">k</span> <span class="nb">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">replica</span><span class="o">-</span><span class="nb">set</span><span class="p">.</span><span class="n">yml</span>      <span class="c1"># to manage orphaned pods `app=myapp`
</span><span class="n">k</span> <span class="n">get</span> <span class="n">rs</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">rs</span> <span class="n">myapp</span><span class="o">-</span><span class="n">replicaset</span>

<span class="n">k</span> <span class="n">delete</span> <span class="n">rs</span> <span class="n">myapp</span><span class="o">-</span><span class="n">replicaset</span>
<span class="n">k</span> <span class="nb">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">replica</span><span class="o">-</span><span class="n">set2</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">kubectl</span> <span class="n">scale</span> <span class="n">rs</span> <span class="n">myapp</span><span class="o">-</span><span class="n">replicaset</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">6</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">rs</span> <span class="n">myapp</span><span class="o">-</span><span class="n">replicaset</span>
</code></pre></div></div>

<h1 id="kubernetes-services">Kubernetes Services</h1>
<ul>
  <li>A Kubernetes Service provides a single, constant (pod are ephemeral) entry point to a group of pods providing the same service.</li>
  <li>The kube-proxy agent on the nodes watches the k8s API for new services and endpoints.</li>
</ul>

<h1 id="daemonsets">DaemonSets</h1>
<ul>
  <li>A DaemonSet ensures that a Pod is running across a set of nodes.</li>
  <li>Deploy system daemons like log collectors and monitoring agents.</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iE</span> <span class="s">'KIND|daemonse'</span>
<span class="n">kubectl</span> <span class="n">explain</span> <span class="n">DaemonSet</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">daemonset</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">ds</span>            <span class="c1"># inspect daemonsets
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>

<span class="c1"># deploy on specific nodes only (label `sdd: true`)
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">daemonset</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">ds</span>                        <span class="c1"># desired = 0
</span><span class="n">k</span> <span class="n">get</span> <span class="n">nodes</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">labels</span>
<span class="n">k</span> <span class="n">label</span> <span class="n">nodes</span> <span class="n">minikube</span> <span class="n">ssd</span><span class="o">=</span><span class="n">true</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">ds</span>                        <span class="c1"># desired = 1
</span><span class="n">k</span> <span class="n">label</span> <span class="n">nodes</span> <span class="n">minikube</span> <span class="n">ssd</span><span class="o">-</span>     <span class="c1"># remove label
</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">ds</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">ds</span> <span class="n">nginx</span><span class="o">-</span><span class="n">fast</span><span class="o">-</span><span class="n">storage</span> <span class="n">fluentd</span>   <span class="c1"># use --cascade to keep pods
</span></code></pre></div></div>

<h1 id="scheduling-jobs">Scheduling Jobs</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iE</span> <span class="s">'KIND|cron'</span>
<span class="n">kubectl</span> <span class="n">explain</span> <span class="n">cronjob</span><span class="p">.</span><span class="n">spec</span>
<span class="n">kubectl</span> <span class="n">explain</span> <span class="n">cronjob</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">schedule</span>   <span class="c1"># alternative
</span>
<span class="c1"># create pod-cronjob.yml
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">cronjob</span><span class="p">.</span><span class="n">yml</span>

<span class="n">k</span> <span class="n">get</span> <span class="n">cronjobs</span><span class="p">.</span><span class="n">batch</span>        <span class="c1"># list avail. jobs
</span><span class="n">k</span> <span class="n">get</span> <span class="n">jobs</span> <span class="o">--</span><span class="n">watch</span>          <span class="c1"># monitor status
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pods</span>                  <span class="c1"># show completed pods
</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">cronjobs</span><span class="p">.</span><span class="n">batch</span> <span class="n">pod</span><span class="o">-</span><span class="n">cronjob</span> 
</code></pre></div></div>

<h1 id="volumes">Volumes</h1>
<ul>
  <li>pods have isolated FS.</li>
  <li>Storage volumes aren’t top level resources like pods, but are defined a s components of the pod.</li>
  <li>Aren’t standalone kubernetes objects and cannot be created or deleted on their own.</li>
  <li>Volumes live with a Pod across a container life cycle.</li>
</ul>

<p>Types of volumes (Volume Type: Storage Provider):</p>

<ul>
  <li>
<strong>emptyDir</strong>: Localhost. Simplest volume type. Will be ereased, when the Pod is removed.</li>
  <li>hostPath: Localhost</li>
  <li>glusterfs: GlusterFS cluster</li>
  <li>downwardAPI: Kubernets Pod Information</li>
  <li>
<strong>nfs</strong>: NFS server</li>
  <li>awsElasticBlockStore: AWS Elastic Block Store</li>
  <li>gcePersistentDsik: Google Compute Engine persistent disk</li>
  <li>azureDisk: Azure disk storage</li>
  <li>projected: Kubernetes resources; currently: secret, downwardAPI and configMap</li>
  <li>secret: K8s secret resource</li>
  <li>vSphereVolume: vSphere VMDK volume</li>
  <li>gitRepo: git repository (volume content will be deleted when Pod is removed)</li>
</ul>

<p>Once you define volumes in <code class="language-python highlighter-rouge"><span class="n">volumes</span></code> section, you can start using them in the <code class="language-python highlighter-rouge"><span class="n">volumeMounts</span></code> section.</p>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">emptyDir</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">emptydir</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">pod</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">emptydir</span> <span class="o">-</span><span class="n">o</span> <span class="n">json</span>

<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">emptydir</span> <span class="o">-</span><span class="n">c</span> <span class="n">alpine1</span> <span class="o">--</span> <span class="n">touch</span> <span class="o">/</span><span class="n">alpine1</span><span class="o">/</span><span class="n">someFile</span><span class="p">.</span><span class="n">txt</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">emptydir</span> <span class="o">-</span><span class="n">c</span> <span class="n">alpine2</span> <span class="o">--</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">alpine2</span>
</code></pre></div></div>

<p>To create the dir in memory using tmpfs:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">volumes</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">data</span>
<span class="o">-</span> <span class="n">emptydir</span><span class="p">:</span>
    <span class="n">medium</span><span class="p">:</span> <span class="n">Memory</span>
</code></pre></div></div>

<p>This gives instead:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">memory</span> <span class="o">-</span><span class="n">c</span> <span class="n">alpine2</span> <span class="o">--</span> <span class="n">df</span> <span class="o">-</span><span class="n">h</span> <span class="o">/</span><span class="n">alpine2</span>
<span class="n">Filesystem</span>                <span class="n">Size</span>      <span class="n">Used</span> <span class="n">Available</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="n">tmpfs</span>                     <span class="mf">1.4</span><span class="n">G</span>         <span class="mi">0</span>      <span class="mf">1.4</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">alpine2</span>
</code></pre></div></div>

<p>Instead of original:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">memory</span> <span class="o">-</span><span class="n">c</span> <span class="n">alpine2</span> <span class="o">--</span> <span class="n">df</span> <span class="o">-</span><span class="n">h</span> <span class="o">/</span><span class="n">alpine2</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">rhel</span><span class="o">-</span><span class="n">root</span>
                     <span class="mf">10.3</span><span class="n">G</span>      <span class="mf">7.9</span><span class="n">G</span>      <span class="mf">1.8</span><span class="n">G</span>  <span class="mi">81</span><span class="o">%</span> <span class="o">/</span><span class="n">alpine2</span>
</code></pre></div></div>

<p><code class="language-python highlighter-rouge"><span class="n">hostPath</span></code> is the first type of persistent storage. Its contents are stored on a node’s FS. It is not a good idea to use <code class="language-python highlighter-rouge"><span class="n">hostPath</span></code> for regular poth, because it makes the app sensitive to pod scheduling. Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">hostpath</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">hostpath</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>   <span class="c1"># get the node IP
</span><span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">shared</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">hostpath</span> <span class="o">-</span><span class="n">c</span> <span class="n">alpine1</span> <span class="o">--</span> <span class="n">touch</span> <span class="o">/</span><span class="n">alpine1</span><span class="o">/</span><span class="n">someFile</span><span class="p">.</span><span class="n">txt</span>      

<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">nodeIP</span><span class="p">]</span><span class="c1"># ls -l /tmp/data/
</span><span class="n">total</span> <span class="mi">0</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="n">Jan</span>  <span class="mi">7</span> <span class="mi">15</span><span class="p">:</span><span class="mi">26</span> <span class="n">someFile</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div></div>

<h2 id="nfs">NFS</h2>
<p>First make sure that <code class="language-python highlighter-rouge"><span class="n">nfs</span><span class="o">-</span><span class="n">utils</span></code> package is installed on k8s minions. Check <code class="language-python highlighter-rouge"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span></code> and make sure it can be mounted using <code class="language-python highlighter-rouge"><span class="n">nfs</span> <span class="o">-</span><span class="n">t</span> <span class="n">nfs</span> <span class="n">server</span><span class="p">:</span><span class="n">share</span> <span class="n">mountpoint</span></code>. Examples:</p>

<p>kubectl create -f shared-volume-nfs.yml
kubectl get pods shared-volume-nfs -o wide  # wait for <code class="language-python highlighter-rouge"><span class="n">Running</span></code> state
kubectl describe pod <pod-name>     # check mounting status</pod-name></p>

<p>K8s actually mounts <code class="language-python highlighter-rouge"><span class="n">server</span><span class="p">:</span><span class="n">share</span> </code> into <code class="language-python highlighter-rouge"><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubelet</span><span class="o">/</span><span class="n">pods</span><span class="o">/&lt;</span><span class="nb">id</span><span class="o">&gt;/</span><span class="n">volumes</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">-</span><span class="n">nfs</span><span class="o">/</span><span class="n">nfs</span></code> and then mounts it into the container as the destination <code class="language-python highlighter-rouge"><span class="o">/&lt;</span><span class="n">mount</span><span class="o">-</span><span class="n">point</span><span class="o">&gt;</span></code>.</p>

<h2 id="persistent-volumes">Persistent Volumes</h2>

<p>Capacity:</p>

<ul>
  <li>K (kilobyte: 1000 bytes)</li>
  <li>Ki (kibibyte: 1024 bytes)</li>
</ul>

<p>Volume mode is either <code class="language-python highlighter-rouge"><span class="n">Filesystem</span></code> (default) or <code class="language-python highlighter-rouge"><span class="n">Block</span></code>.</p>

<p>Access Modes:</p>

<ul>
  <li>RWO - <strong>ReadWriteOnce</strong> - a single node can mount for RW</li>
  <li>ROX - <strong>ReadOnlyMany</strong>
</li>
  <li>RWX - <strong>ReadWriteMany</strong>
</li>
</ul>

<p>Storage is mounted to nodes, so even with RWO, multiple pods on the same node can mount the volume and write to it.</p>

<p>Reclaim Policy determines, what happens when a persistent volume claim is deleted:</p>
<ul>
  <li>
<strong>Retain</strong>: volume will need to be reclaimed manualy</li>
  <li>
<strong>Delete</strong>: associated storage asset, such as AWS EBS, AzureDisk, OpenStack Cinder volume etc. is deleted.</li>
  <li>
<strong>Recycle</strong>: delete content only. Allows the volume to be claimed again.</li>
</ul>

<p>ATM Only NFS and <code class="language-python highlighter-rouge"><span class="n">HostPath</span></code> support recycling. AWS EBS, GCE PD, Azure Disk and Cinder volumes support deletion.</p>

<p>Example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iE</span> <span class="s">'KIND|persistent'</span>
<span class="n">k</span> <span class="n">explain</span> <span class="n">PersistentVolume</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span> <span class="n">f</span> <span class="n">persistent</span><span class="o">-</span><span class="n">volume</span><span class="p">.</span><span class="n">yml</span>

<span class="c1"># kubectl get pv
</span><span class="n">NAME</span>           <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">RECLAIM</span> <span class="n">POLICY</span>   <span class="n">STATUS</span>      <span class="n">CLAIM</span>   <span class="n">STORAGECLASS</span>   <span class="n">REASON</span>   <span class="n">AGE</span>
<span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">ROX</span><span class="p">,</span><span class="n">RWX</span>        <span class="n">Recycle</span>          <span class="n">Available</span>                                   <span class="mi">18</span><span class="n">s</span>
</code></pre></div></div>

<p><code class="language-python highlighter-rouge"><span class="n">PersistentVolumes</span></code> don’t belong to any namespace. They are cluster-level resources like nodes.</p>

<h3 id="persistentvolumeclaim">PersistentVolumeClaim</h3>

<p>Claiming a <code class="language-python highlighter-rouge"><span class="n">PersistentVolume</span></code> is completely separate process from creating a pod.</p>

<p>Example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">explain</span> <span class="n">PersistentVolumeClaim</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>

<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get pvc
</span><span class="n">NAME</span>            <span class="n">STATUS</span>   <span class="n">VOLUME</span>         <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">STORAGECLASS</span>   <span class="n">AGE</span>
<span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pvc</span>   <span class="n">Bound</span>    <span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">ROX</span><span class="p">,</span><span class="n">RWX</span>   

<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get pv
</span><span class="n">NAME</span>           <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">RECLAIM</span> <span class="n">POLICY</span>   <span class="n">STATUS</span>   <span class="n">CLAIM</span>                   <span class="n">STORAGECLASS</span>   <span class="n">REASON</span>   <span class="n">AGE</span>
<span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">ROX</span><span class="p">,</span><span class="n">RWX</span>        <span class="n">Recycle</span>          <span class="n">Bound</span>    <span class="n">default</span><span class="o">/</span><span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pvc</span>                           <span class="mi">7</span><span class="n">m26s</span>

<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl describe pvc nfs-share-pvc
</span><span class="n">Name</span><span class="p">:</span>          <span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pvc</span>
<span class="n">Namespace</span><span class="p">:</span>     <span class="n">default</span>
<span class="n">StorageClass</span><span class="p">:</span>
<span class="n">Status</span><span class="p">:</span>        <span class="n">Bound</span>
<span class="n">Volume</span><span class="p">:</span>        <span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pv</span>
<span class="n">Labels</span><span class="p">:</span>        <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">Annotations</span><span class="p">:</span>   <span class="n">pv</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">bind</span><span class="o">-</span><span class="n">completed</span><span class="p">:</span> <span class="n">yes</span>
            <span class="n">pv</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">bound</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">controller</span><span class="p">:</span> <span class="n">yes</span>
<span class="n">Finalizers</span><span class="p">:</span>    <span class="p">[</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">pvc</span><span class="o">-</span><span class="n">protection</span><span class="p">]</span>
<span class="n">Capacity</span><span class="p">:</span>      <span class="mi">1</span><span class="n">Gi</span>
<span class="n">Access</span> <span class="n">Modes</span><span class="p">:</span>  <span class="n">ROX</span><span class="p">,</span><span class="n">RWX</span>
<span class="n">VolumeMode</span><span class="p">:</span>    <span class="n">Filesystem</span>
<span class="n">Mounted</span> <span class="n">By</span><span class="p">:</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">Events</span><span class="p">:</span>        <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>PV is now yours to use. Nobody else can claim it until you release it.</p>

<h4 id="using-a-persistentvolumeclaim-in-a-pod">Using a PersistentVolumeClaim in a Pod</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubectl create -f nfs-share-pod.yml
# kubectl get pods pod-nfs-share      # make sure pod is Running
# kubectl exec -it pod-nfs-share -- df -h /var/www
</span><span class="n">Filesystem</span>                <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="mf">192.168</span><span class="p">.</span><span class="mf">43.48</span><span class="p">:</span><span class="o">/</span><span class="n">nfs_share</span>   <span class="mi">14</span><span class="n">G</span>  <span class="mf">8.6</span><span class="n">G</span>  <span class="mf">4.1</span><span class="n">G</span>  <span class="mi">68</span><span class="o">%</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
</code></pre></div></div>

<p>Recycle Persistent Volumes:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">delete</span> <span class="n">pod</span> <span class="n">pod</span><span class="o">-</span><span class="n">nfs</span><span class="o">-</span><span class="n">share</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">pvc</span> <span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pvc</span>

<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get pv     # Status - Released
</span><span class="n">NAME</span>           <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">RECLAIM</span> <span class="n">POLICY</span>   <span class="n">STATUS</span>     <span class="n">CLAIM</span>                         <span class="n">STORAGECLASS</span>    <span class="n">REASON</span>   <span class="n">AGE</span>
<span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">ROX</span><span class="p">,</span><span class="n">RWX</span>        <span class="n">Recycle</span>          <span class="n">Released</span>   <span class="n">default</span><span class="o">/</span><span class="n">nfs</span><span class="o">-</span><span class="n">share</span><span class="o">-</span><span class="n">pvc</span>                                  <span class="mi">80</span><span class="n">m</span>
</code></pre></div></div>

<p>If we would have used <code class="language-python highlighter-rouge"><span class="n">Retain</span></code> <code class="language-python highlighter-rouge"><span class="n">ReclaimPolicy</span></code> then we would have to manually clean up the data in order to bind the <code class="language-python highlighter-rouge"><span class="n">PersistentVolume</span></code> again.</p>

<h4 id="local-persistent-volumes-with-storageclass">Local Persistent Volumes with StorageClass</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">storage</span><span class="o">-</span><span class="n">class</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">sc</span>    <span class="c1"># check status
</span>
<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">local</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">sc</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pv</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">pv</span> <span class="n">local</span><span class="o">-</span><span class="n">pv</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">local</span><span class="o">-</span><span class="n">pvc</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pvc</span>       <span class="c1"># STATUS = Pending
</span><span class="n">k</span> <span class="n">describe</span> <span class="n">pvc</span> <span class="n">local</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">claim</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">local</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">pod</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="n">local</span><span class="o">-</span><span class="n">pod</span>        <span class="c1"># make sure it is `Running`
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pvc</span>                   <span class="c1"># STATUS=Bound
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pv</span>                    <span class="c1"># STATUS=Bound
</span></code></pre></div></div>

<h2 id="configmaps">ConfigMaps</h2>
<ul>
  <li>Env-specfic data is provided to the application by the env it is deployed into.</li>
  <li>ConfigMap defines application related data.</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span> <span class="n">create</span> <span class="n">configmap</span> <span class="n">my</span><span class="o">-</span><span class="n">config</span>
    <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="nb">file</span><span class="o">=</span><span class="n">foo</span><span class="p">.</span><span class="n">json</span>            <span class="c1"># single file
</span>    <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="nb">file</span><span class="o">=</span><span class="n">bar</span><span class="o">=</span><span class="n">foo</span><span class="p">.</span><span class="n">json</span>        <span class="c1"># single file stored under custom key
</span>    <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="nb">file</span><span class="o">=</span><span class="n">config</span><span class="o">-</span><span class="n">opts</span><span class="o">/</span>        <span class="c1"># dir
</span>    <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="n">literal</span><span class="o">=</span><span class="n">foo</span><span class="o">=</span><span class="n">bar</span>          <span class="c1"># literal value
</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">cm</span> <span class="n">nginx</span><span class="o">-</span><span class="n">cm</span> <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="nb">file</span> <span class="n">nginx</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">config</span><span class="p">.</span><span class="n">conf</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">cm</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">cm</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">nginx</span><span class="o">-</span><span class="n">cm</span> <span class="o">--</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">default</span><span class="p">.</span><span class="n">conf</span>

<span class="c1"># create CM using CLI args
</span><span class="n">k</span> <span class="n">create</span> <span class="n">cm</span> <span class="n">myconfig</span> <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="n">literal</span><span class="o">=</span><span class="n">color</span><span class="o">=</span><span class="n">red</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">cm</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">test</span><span class="o">-</span><span class="n">cm</span><span class="o">-</span><span class="n">pod</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">test</span><span class="o">-</span><span class="n">pod</span> <span class="o">--</span> <span class="n">env</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">COLOR</span>
</code></pre></div></div>

<h2 id="kubernetes-secrets">Kubernetes Secrets</h2>
<ul>
  <li>Indented to store small amount (1 MB for a secret) of sensitive data.</li>
  <li>A secret is base64 encoded, so we cannot treat it as secure.</li>
  <li>K8s ensures that Secrets are passed only to the nodes that are running Pods that need the respective secrets.</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="n">secret</span> <span class="n">generic</span> <span class="n">test</span><span class="o">-</span><span class="n">secret</span>  <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="n">literal</span><span class="o">=</span><span class="n">user</span><span class="o">=</span><span class="n">deepak</span> <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="n">literal</span><span class="o">=</span><span class="n">password</span><span class="o">=</span><span class="n">test1234</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">secrets</span> <span class="n">test</span><span class="o">-</span><span class="n">secret</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span>
<span class="n">echo</span> <span class="n">dGVzdDEyMzQ</span><span class="o">=</span> <span class="o">|</span> <span class="n">base64</span> <span class="o">--</span><span class="n">decode</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">secret</span><span class="o">-</span><span class="n">busybox</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">secret</span><span class="o">-</span><span class="n">busybox</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span>
    <span class="c1"># cat data/password
</span>    <span class="c1"># cat data/user
</span></code></pre></div></div>

<p>Defining secrets from a file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="n">secret</span> <span class="n">generic</span> <span class="n">secret</span><span class="o">-</span><span class="n">tls</span> <span class="o">--</span><span class="k">from</span><span class="o">=</span><span class="nb">file</span><span class="o">=</span><span class="n">server</span><span class="p">.</span><span class="n">crt</span> <span class="o">--</span><span class="k">from</span><span class="o">-</span><span class="nb">file</span><span class="o">=</span><span class="n">server</span><span class="p">.</span><span class="n">key</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">secret</span> <span class="n">secret</span><span class="o">-</span><span class="n">tls</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">secret</span><span class="o">-</span><span class="n">ls</span><span class="o">-</span><span class="n">pod</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="n">secret</span><span class="o">-</span><span class="n">tls</span><span class="o">-</span><span class="n">pod</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">secret</span><span class="o">-</span><span class="n">ls</span><span class="o">-</span><span class="n">pod</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span>
    <span class="c1"># ls -l /tls
</span></code></pre></div></div>

<h1 id="stateful-sets">Stateful sets</h1>
<ul>
  <li>Available from k8s 1.5 as a bond between the Pod and the Persistent Volume.</li>
  <li><strong>Pods names consist of name-I where I is zero based index.</strong></li>
  <li>Replaced Pods get the same name and hostname as the Pod that has been
replaced.</li>
  <li>Limitations:
    <ul>
      <li>storage for a given Pod must be provisioned by a PersistentVolume
Provisioner</li>
      <li>deleting and/or scaling will not delete associated volumes.</li>
      <li>Headless Service is required to be responsible for the network identity
of the Pods. You’re responsible for creating this Service.</li>
      <li>No guarantee on termination of pods on deletion. To achieve ordered and
graceful termination of the pods, scale the StatefulSet down to 0 prior
deletion.</li>
      <li>When using Rolling Updates with the default Pod Management Policy
(OrderedReady), it’s possible to get into a broken state that requires
manual intervention to repair.</li>
    </ul>
  </li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># exportfs -v
</span><span class="o">/</span><span class="n">share1</span>         <span class="p">(</span><span class="n">sync</span><span class="p">,</span><span class="n">wdelay</span><span class="p">,</span><span class="n">hide</span><span class="p">,</span><span class="n">no_subtree_check</span><span class="p">,</span><span class="n">sec</span><span class="o">=</span><span class="n">sys</span><span class="p">,</span><span class="n">rw</span><span class="p">,</span><span class="n">secure</span><span class="p">,</span><span class="n">no_root_squash</span><span class="p">,</span><span class="n">no_all_squash</span><span class="p">)</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nfs</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">share1</span><span class="p">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">f</span> <span class="n">nfs</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">share2</span><span class="p">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">f</span> <span class="n">nfs</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">share3</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iE</span> <span class="s">'KIND|stateful'</span>
<span class="n">k</span> <span class="n">explain</span> <span class="n">StatefulSet</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nfs</span><span class="o">-</span><span class="n">stateful</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">statefulsets</span>      <span class="c1"># READY = 0/3
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pvc</span>               <span class="c1"># STATUS = Bound
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pv</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span>              <span class="c1"># no fancy names
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pv</span>                <span class="c1"># all claimed
</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">nginx</span><span class="o">-</span><span class="n">statefulset</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">c</span> <span class="n">nginx</span><span class="o">-</span><span class="n">statefulset</span> <span class="o">--</span> <span class="n">touch</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">pod3</span><span class="o">-</span><span class="nb">file</span>
<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># ls -l /share3/
</span><span class="n">total</span> <span class="mi">0</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="n">Jan</span>  <span class="mi">9</span> <span class="mi">16</span><span class="p">:</span><span class="mi">44</span> <span class="n">pod3</span><span class="o">-</span><span class="nb">file</span>

<span class="n">k</span> <span class="n">delete</span> <span class="n">pod</span> <span class="n">nginx</span><span class="o">-</span><span class="n">statefulset</span><span class="o">-</span><span class="mi">2</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>      <span class="c1"># new pod is being created with same IP and nodename
</span><span class="n">kubectl</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">nginx</span><span class="o">-</span><span class="n">statefulset</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">c</span> <span class="n">nginx</span><span class="o">-</span><span class="n">statefulset</span> <span class="o">--</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span> <span class="c1"># `pod3-file` is there
</span></code></pre></div></div>

<h1 id="k8s-api-server">K8s API Server</h1>
<ul>
  <li>In k8s all communication between control plane and external clients (e.g. kubectl) are translated into REST API calls handled by the API server. The API server is the only component that talks directly with distributed storage etcd.</li>
  <li>API server responsibilities is to provide k8s API and to proxy cluster components (e.g. dashboard), stream logs, service ports or serve kubectl exec sessions.</li>
  <li>Master: etcd &lt;-&gt; API Server (Control Manager + Scheduler)</li>
  <li>Worker: kubelet, native app</li>
  <li>The API server is stateless and designed to scale horizontally. For HA it is recommended to have 3+ instances.</li>
</ul>

<p>Examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</code></pre></div></div>

<p><strong>K8s HTTP Request flow</strong>: client (kubectl) + Service Account -&gt; authentification -&gt; authorization -&gt; admission control -&gt; etcd.</p>

<p>After the request is authenticated and authorized, it goes to the admission control modules. K8s comes with predefined admission controllers, but you can define custom ones as well.</p>

<h2 id="service-account--roles">Service Account + Roles</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="nb">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">service</span><span class="o">-</span><span class="n">account</span><span class="p">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">f</span> <span class="n">cluster</span><span class="o">-</span><span class="n">role</span><span class="p">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">f</span> <span class="n">cluster</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">binding</span><span class="p">.</span><span class="n">yml</span>

<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">pod</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">minikube</span>

<span class="c1"># forbidden - returned by authorization plugin
</span><span class="n">k</span> <span class="o">--</span><span class="k">as</span><span class="o">=</span><span class="n">system</span><span class="p">:</span><span class="n">serviceaccount</span><span class="p">:</span><span class="n">default</span><span class="p">:</span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">user</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span>
<span class="n">k</span> <span class="o">--</span><span class="k">as</span><span class="o">=</span><span class="n">system</span><span class="p">:</span><span class="n">serviceaccount</span><span class="p">:</span><span class="n">default</span><span class="p">:</span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">user</span> <span class="n">describe</span> <span class="n">pod</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">minikube</span>

<span class="c1"># inquiry 
</span><span class="n">k</span> <span class="n">auth</span> <span class="n">can</span><span class="o">-</span><span class="n">i</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span>  <span class="c1"># yes
</span><span class="n">k</span> <span class="o">--</span><span class="k">as</span><span class="o">=</span><span class="n">system</span><span class="p">:</span><span class="n">serviceaccount</span><span class="p">:</span><span class="n">default</span><span class="p">:</span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">user</span> <span class="n">auth</span> <span class="n">can</span><span class="o">-</span><span class="n">i</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span>

<span class="n">k</span> <span class="n">delete</span> <span class="n">serviceaccount</span> <span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">user</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">clusterrole</span> <span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">role</span>
</code></pre></div></div>

<p>HTTP Interface of the API Server:</p>

<ul>
  <li>POST: k create -f</li>
  <li>PUT: k apply -f</li>
  <li>GET: k get; k describe</li>
  <li>PATCH: k set image deployment/kuberserve nginx=nginx1.9.1</li>
  <li>DELETE: k delete</li>
</ul>

<p>API resources and versions:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span>
<span class="n">k</span> <span class="n">api</span><span class="o">-</span><span class="n">versions</span>

<span class="n">k</span> <span class="n">explain</span> <span class="n">pod</span>  <span class="c1"># for any resource kind
</span></code></pre></div></div>

<p>K8s API via CLI:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">get</span> <span class="o">--</span><span class="n">raw</span> <span class="o">/</span>       <span class="c1"># get all API resources
</span><span class="n">k</span> <span class="n">get</span> <span class="o">--</span><span class="n">raw</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespaces</span>  <span class="o">|</span> <span class="n">jq</span>
<span class="n">k</span> <span class="n">get</span> <span class="o">--</span><span class="n">raw</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">default</span>  <span class="o">|</span> <span class="n">jq</span>

<span class="c1"># access using curl
</span><span class="n">k</span> <span class="n">proxy</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">9000</span>
<span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9000</span><span class="o">/</span><span class="n">apis</span> <span class="o">|</span> <span class="n">less</span>
<span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9000</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">deployments</span>
</code></pre></div></div>

<h2 id="containers-security-context">Container’s Security Context</h2>
<ul>
  <li>Each pod gets its own IP and port space. Each pod has its own process tree, its own IPC namespace, allowing only processes in the same pod to communicate through IPC.</li>
  <li>Here we learn to allow pods to access resources of the node they’re running on.</li>
</ul>

<p>Example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">host</span><span class="o">-</span><span class="n">network</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">k</span> <span class="k">exec</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">host</span><span class="o">-</span><span class="n">network</span> <span class="o">--</span> <span class="n">ifconfig</span>

<span class="c1"># Allow pods to bind a port in the node's default namespace 
# using `ports.hostPort`
# (only one instance of the pod can be schedules to each node)
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">lab</span><span class="p">.</span><span class="n">yml</span>
<span class="n">curl</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9000</span>     <span class="c1"># XXX doesn't work (because of minikube?)
</span>
<span class="c1"># Using node's PID and IPC namespaces
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">host</span><span class="o">-</span><span class="n">pid</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">ipc</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="k">exec</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">host</span><span class="o">-</span><span class="n">pid</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">ipc</span> <span class="o">--</span> <span class="n">ps</span> <span class="n">aux</span>  <span class="c1"># includes container process
</span></code></pre></div></div>

<h2 id="configure-containers-security-context">Configure container’s security context</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># run with given user
</span><span class="err">$</span> <span class="n">k</span> <span class="n">run</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">defaults</span> <span class="o">--</span><span class="n">image</span> <span class="n">alpine</span> <span class="o">--</span><span class="n">restart</span> <span class="n">Never</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sleep</span> <span class="mi">99999</span>
<span class="err">$</span> <span class="n">k</span> <span class="k">exec</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">defaults</span> <span class="o">--</span> <span class="nb">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">),</span><span class="mi">1</span><span class="p">(</span><span class="nb">bin</span><span class="p">),</span><span class="mi">2</span><span class="p">(</span><span class="n">daemon</span><span class="p">),</span><span class="mi">3</span><span class="p">(</span><span class="n">sys</span><span class="p">),</span><span class="mi">4</span><span class="p">(</span><span class="n">adm</span><span class="p">),</span><span class="mi">6</span><span class="p">(</span><span class="n">disk</span><span class="p">),</span><span class="mi">10</span><span class="p">(</span><span class="n">wheel</span><span class="p">),</span><span class="mi">11</span><span class="p">(</span><span class="n">floppy</span><span class="p">),</span><span class="mi">20</span><span class="p">(</span><span class="n">dialout</span><span class="p">),</span><span class="mi">26</span><span class="p">(</span><span class="n">tape</span><span class="p">),</span><span class="mi">27</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>
<span class="err">$</span> <span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">guest</span><span class="p">.</span><span class="n">yml</span> 
<span class="err">$</span> <span class="n">k</span> <span class="k">exec</span> <span class="n">pod</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">guest</span> <span class="o">--</span> <span class="nb">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">65534</span><span class="p">(</span><span class="n">nobody</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">65534</span><span class="p">(</span><span class="n">nobody</span><span class="p">)</span>

<span class="c1"># run as non-root
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">run</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">non</span><span class="o">-</span><span class="n">root</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">po</span> <span class="n">pod</span><span class="o">-</span><span class="n">run</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">non</span><span class="o">-</span><span class="n">root</span>        <span class="c1"># STATUS=CreateContainerConfigError
</span><span class="n">k</span> <span class="n">describe</span> <span class="n">pods</span> <span class="n">pod</span><span class="o">-</span><span class="n">run</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">non</span><span class="o">-</span><span class="n">root</span> <span class="c1"># Error: container has runAsNonRoot and image will run as root
</span>
<span class="c1"># run in privileged mode (to get full access to node's kernel)
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">privileged</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">defaults</span> <span class="o">--</span> <span class="n">ls</span> <span class="o">/</span><span class="n">dev</span>     <span class="c1"># 16
</span><span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">pod</span><span class="o">-</span><span class="n">privileged</span> <span class="o">--</span> <span class="n">ls</span> <span class="o">/</span><span class="n">dev</span>     <span class="c1"># 241
</span></code></pre></div></div>

<h2 id="individual-capabilities">Individual Capabilities</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># add individual capabilities to a container
</span><span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">defaults</span> <span class="o">--</span> <span class="n">date</span> <span class="o">+%</span><span class="n">T</span> <span class="o">-</span><span class="n">s</span> <span class="s">"12:00:00"</span>      <span class="c1"># date: can't set date: Operation not permitted
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">settime</span><span class="o">-</span><span class="n">capability</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">pod</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">settime</span><span class="o">-</span><span class="n">capability</span> <span class="o">--</span> <span class="n">date</span> <span class="o">+%</span><span class="n">T</span> <span class="o">-</span><span class="n">s</span> <span class="s">"12:00:00"</span><span class="p">;</span> <span class="n">date</span>

<span class="c1"># drop individual capabilities from a container
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">drop</span><span class="o">-</span><span class="n">chown</span><span class="o">-</span><span class="n">capability</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">k</span> <span class="k">exec</span> <span class="n">pod</span><span class="o">-</span><span class="n">drop</span><span class="o">-</span><span class="n">chown</span><span class="o">-</span><span class="n">capability</span> <span class="o">--</span> <span class="n">chown</span> <span class="n">guest</span> <span class="o">/</span><span class="n">tmp</span>    <span class="c1"># operation not permitted
</span>
<span class="c1"># ro FS
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">readonly</span><span class="o">-</span><span class="n">filesystem</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">readonly</span><span class="o">-</span><span class="n">filesystem</span> <span class="o">--</span> <span class="n">touch</span> <span class="o">/</span><span class="n">new</span><span class="o">-</span><span class="nb">file</span>  <span class="c1"># exit 1 - Read-only file system
</span>
<span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">readonly</span><span class="o">-</span><span class="n">filesystem</span> <span class="o">--</span> <span class="n">touch</span> <span class="o">/</span><span class="n">volume</span><span class="o">/</span><span class="n">newfile</span>    <span class="c1"># works
</span><span class="n">k</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">readonly</span><span class="o">-</span><span class="n">filesystem</span> <span class="o">--</span> <span class="n">ls</span> <span class="o">-</span><span class="n">la</span> <span class="o">/</span><span class="n">volume</span><span class="o">/</span><span class="n">newfile</span>
</code></pre></div></div>

<h1 id="authentication">Authentication</h1>
<ul>
  <li>Client certificates (most common) using X509 CA. <code class="language-python highlighter-rouge"><span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="nb">file</span><span class="o">=</span><span class="n">file_path</span></code> server option.</li>
  <li>Static tokens: ``-token-auth-file=<code class="language-python highlighter-rouge"><span class="p">.</span> <span class="n">Tokens</span> <span class="n">persist</span> <span class="n">indefinitely</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">API</span> <span class="n">server</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">restarted</span> <span class="n">to</span> <span class="n">update</span> <span class="n">the</span> <span class="n">tokens</span><span class="p">.</span> <span class="n">Username</span> <span class="ow">and</span> <span class="n">password</span> <span class="n">are</span> <span class="n">passed</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">request</span> <span class="n">header</span><span class="p">:</span> </code>Authentication: Basic base64(user:password)`</li>
  <li>Bootstrap tokens: are dynamically managed and stored as secrets in <code class="language-python highlighter-rouge"><span class="n">kube</span><span class="o">-</span><span class="n">system</span></code>. <code class="language-python highlighter-rouge"><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">auth</span></code> option for the CLI server.</li>
  <li>Service account tokens: <code class="language-python highlighter-rouge"><span class="o">--</span><span class="n">service</span><span class="o">-</span><span class="n">acount</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="nb">file</span></code>
</li>
  <li>Authentication proxy: <code class="language-python highlighter-rouge"><span class="o">--</span><span class="n">requestheader</span><span class="o">-</span><span class="p">{</span><span class="n">username</span><span class="o">-</span><span class="n">headers</span><span class="p">,</span><span class="n">group</span><span class="o">-</span><span class="n">headers</span><span class="p">,</span><span class="n">extra</span><span class="o">-</span><span class="n">headers</span><span class="o">-</span><span class="n">prefix</span><span class="p">}</span></code> arguments.</li>
  <li>Webhook tokens: <code class="language-python highlighter-rouge"><span class="n">authorization</span><span class="o">-</span><span class="n">webhook</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="nb">file</span><span class="o">=</span></code>
</li>
</ul>

<p><code class="language-python highlighter-rouge"><span class="n">kubectl</span></code> uses certificates stores in <code class="language-python highlighter-rouge"><span class="o">~/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span></code> or <code class="language-python highlighter-rouge"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span></code>.</p>

<p>Example using client certificates:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl config view | grep server
</span><span class="n">server</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="p">.</span><span class="mf">43.48</span><span class="p">:</span><span class="mi">6443</span>

<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># curl https://192.168.43.48:6443
</span><span class="n">curl</span><span class="p">:</span> <span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="n">SSL</span> <span class="n">certificate</span> <span class="n">problem</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">get</span> <span class="n">local</span> <span class="n">issuer</span> <span class="n">certificate</span>

<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># export client=$(grep client-cert /etc/kubernetes/admin.conf | cut -d " " -f 6)
</span><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># export key=$(grep client-key-data /etc/kubernetes/admin.conf | cut -d " " -f 6)
</span><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># export auth=$(grep certificate-authority-data /etc/kubernetes/admin.conf | cut -d " " -f 6)
</span>
<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># echo $client | base64 -d - &gt; client.pem
</span><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># echo $key | base64 -d - &gt; client-key.pem
</span><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># echo $auth | base64 -d - &gt; ca.pem
</span>
<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">controller</span> <span class="o">~</span><span class="p">]</span><span class="c1"># curl --cert client.pem --key client-key.pem --cacert ca.pem  https://192.168.43.48:6443   # works 
</span></code></pre></div></div>

<h1 id="authorization">Authorization</h1>

<ul>
  <li>Node. Enabled by default.</li>
  <li>ABAC: requests are validating policies against the attributes of the request. <code class="language-python highlighter-rouge"><span class="o">--</span><span class="n">authorization</span><span class="o">-</span><span class="n">policy</span><span class="o">-</span><span class="nb">file</span><span class="o">=</span></code> and <code class="language-python highlighter-rouge"><span class="o">--</span><span class="n">authorization</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="n">ABAC</span></code> options.</li>
  <li>RBAC. To enable start the API server with <code class="language-python highlighter-rouge"><span class="o">--</span><span class="n">authorization</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="n">RBAC</span></code>.</li>
  <li>Webhooks (uses remote API server to check for permissions). Option <code class="language-python highlighter-rouge"><span class="o">--</span><span class="n">authorization</span><span class="o">-</span><span class="n">webhook</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="nb">file</span><span class="o">=</span></code>.</li>
</ul>

<h2 id="rbac">RBAC</h2>

<p>kubeconfig:</p>

<ul>
  <li>users: username and authentication mechanism</li>
  <li>clusters: all data necessary to connect to the cluster</li>
  <li>contexts: association between users and clusters</li>
</ul>

<p>Create user example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create linux user
</span><span class="n">useradd</span> <span class="o">-</span><span class="n">G</span> <span class="n">nogroup</span> <span class="n">user1</span>
<span class="n">passwd</span> <span class="n">user1</span>

<span class="c1"># create certs
</span><span class="n">openssl</span> <span class="n">genrsa</span> <span class="o">-</span><span class="n">out</span> <span class="n">user1</span><span class="p">.</span><span class="n">key</span> <span class="mi">4096</span>
<span class="n">openssl</span> <span class="n">req</span> <span class="o">-</span><span class="n">new</span> <span class="o">-</span><span class="n">key</span> <span class="n">user1</span><span class="p">.</span><span class="n">key</span> <span class="o">-</span><span class="n">out</span> <span class="n">user1</span><span class="p">.</span><span class="n">csr</span> <span class="o">-</span><span class="n">subj</span> <span class="s">"/CN=user1/O=dev"</span>  <span class="c1"># cert. signing request
# openssl x509 -req -in user1.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out user1.crt -days 365
</span><span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="n">req</span> <span class="o">-</span><span class="ow">in</span> <span class="n">user1</span><span class="p">.</span><span class="n">csr</span> <span class="o">-</span><span class="n">CA</span> <span class="o">~/</span><span class="p">.</span><span class="n">minikube</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">CAkey</span> <span class="o">~/</span><span class="p">.</span><span class="n">minikube</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="n">key</span> <span class="o">-</span><span class="n">CAcreateserial</span> <span class="o">-</span><span class="n">out</span> <span class="n">user1</span><span class="p">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">days</span> <span class="mi">365</span>

<span class="c1"># create namespace (optional)
</span><span class="n">k</span> <span class="n">create</span> <span class="n">namespace</span> <span class="n">dev</span>
 
<span class="c1"># update k8s config with user credentials
</span><span class="n">k</span> <span class="n">config</span> <span class="n">view</span>
<span class="n">k</span> <span class="n">config</span> <span class="nb">set</span><span class="o">-</span><span class="n">credentials</span> <span class="n">user1</span> <span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">certificate</span><span class="o">=</span><span class="n">user1</span><span class="p">.</span><span class="n">crt</span> <span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">key</span><span class="o">=</span><span class="n">user1</span><span class="p">.</span><span class="n">key</span>
<span class="n">k</span> <span class="n">config</span> <span class="n">view</span>

<span class="c1"># create security context for new user
</span><span class="n">k</span> <span class="n">config</span> <span class="nb">set</span><span class="o">-</span><span class="n">context</span> <span class="n">user1</span><span class="o">-</span><span class="n">context</span> <span class="o">--</span><span class="n">cluster</span><span class="o">=</span><span class="n">kubernetes</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">dev</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">user1</span>    <span class="c1"># and set default namespace
</span><span class="n">k</span> <span class="n">config</span> <span class="n">get</span><span class="o">-</span><span class="n">contexts</span>
<span class="n">k</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">user1</span><span class="o">-</span><span class="n">context</span> <span class="n">get</span> <span class="n">pods</span>  <span class="c1"># XXX failed (minikube?)
</span></code></pre></div></div>

<p>Define new role with “modify” permission:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span> <span class="n">api</span><span class="o">-</span><span class="n">resources</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iE</span> <span class="s">'role|KIND'</span>
<span class="n">k</span> <span class="n">explain</span> <span class="n">Role</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">dev</span><span class="o">-</span><span class="n">role</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">user1</span><span class="o">-</span><span class="n">rolebind</span><span class="p">.</span><span class="n">yml</span> 

<span class="n">k</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">user1</span><span class="o">-</span><span class="n">context</span> <span class="n">get</span> <span class="n">pods</span>      <span class="c1"># XXX failed (minikube?)
</span>
<span class="n">k</span> <span class="o">-</span><span class="n">n</span> <span class="n">dev</span> <span class="n">describe</span> <span class="n">role</span> <span class="n">dev</span>

<span class="n">k</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">devnginx</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">nginx</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">user1</span><span class="o">-</span><span class="n">context</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span>          <span class="c1"># not there
</span><span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">dev</span>   <span class="c1"># but here
</span>
<span class="c1"># testing
</span><span class="n">k</span> <span class="n">auth</span> <span class="n">can</span><span class="o">-</span><span class="n">i</span> <span class="n">create</span> <span class="n">pods</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">user1</span><span class="o">-</span><span class="n">context</span>    <span class="c1"># yes
</span><span class="n">k</span> <span class="n">auth</span> <span class="n">can</span><span class="o">-</span><span class="n">i</span> <span class="n">create</span> <span class="n">service</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">user1</span><span class="o">-</span><span class="n">context</span>    <span class="c1"># no
</span>
<span class="c1"># Define role with "view-only" permission
</span><span class="n">k</span> <span class="n">create</span> <span class="n">namespace</span> <span class="n">view</span><span class="o">-</span><span class="n">only</span>
<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">view</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">role</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">view</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">rolebinding</span><span class="p">.</span><span class="n">yml</span>

<span class="n">k</span> <span class="n">config</span> <span class="nb">set</span><span class="o">-</span><span class="n">context</span> <span class="n">viewonly</span><span class="o">-</span><span class="n">context</span> <span class="o">--</span><span class="n">cluster</span><span class="o">=</span><span class="n">kubernetes</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">view</span><span class="o">-</span><span class="n">only</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">user1</span>
<span class="n">k</span> <span class="n">config</span> <span class="n">get</span><span class="o">-</span><span class="n">contexts</span>

<span class="n">k</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">viewonly</span><span class="o">-</span><span class="n">context</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">k</span> <span class="o">-</span><span class="n">n</span> <span class="n">view</span><span class="o">-</span><span class="n">only</span> <span class="n">describe</span> <span class="n">role</span> <span class="n">view</span><span class="o">-</span><span class="n">only</span>
<span class="n">k</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">testnginx</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">nginx</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">viewonly</span><span class="o">-</span><span class="n">context</span>    <span class="c1"># FORBIDDEN
</span>
<span class="n">k</span> <span class="n">auth</span> <span class="n">can</span><span class="o">-</span><span class="n">i</span> <span class="n">create</span> <span class="n">pods</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">viewonly</span><span class="o">-</span><span class="n">context</span>     <span class="c1"># no
</span><span class="n">k</span> <span class="n">auth</span> <span class="n">can</span><span class="o">-</span><span class="n">i</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">viewonly</span><span class="o">-</span><span class="n">context</span>        <span class="c1"># yes
</span><span class="n">k</span> <span class="n">auth</span> <span class="n">can</span><span class="o">-</span><span class="n">i</span> <span class="n">get</span> <span class="n">service</span> <span class="o">--</span><span class="n">context</span><span class="o">=</span><span class="n">viewonly</span><span class="o">-</span><span class="n">context</span>     <span class="c1"># no
</span></code></pre></div></div>

<p>Deleting Context, Role, RoleBinding:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">config</span> <span class="n">delete</span><span class="o">-</span><span class="n">context</span> <span class="n">user1</span><span class="o">-</span><span class="n">context</span>
<span class="n">k</span> <span class="n">config</span> <span class="n">delete</span><span class="o">-</span><span class="n">context</span> <span class="n">viewonly</span><span class="o">-</span><span class="n">context</span>

<span class="n">k</span> <span class="n">delete</span> <span class="n">role</span> <span class="n">dev</span> <span class="o">-</span><span class="n">n</span> <span class="n">dev</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">rolebinding</span> <span class="n">dev</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">binding</span> <span class="o">-</span><span class="n">n</span> <span class="n">dev</span>
</code></pre></div></div>

<h1 id="limit-resources">Limit Resources</h1>
<ul>
  <li>Resource quota is applied on the namespace.</li>
  <li>Resource limit is applied on the containers.</li>
  <li>If creating or updating a resource violates a quota contraint -&gt; HTTP 403.</li>
  <li>Is quota enabled in a namespace for compute resources (cpu, mem), users must specify requests or limits for those value, otherwise quota system may reject pod creation.</li>
</ul>

<h2 id="resource-quota-types">Resource quota types</h2>
<p>Compute resources:</p>

<ul>
  <li>
<strong>limits.cpu</strong>: sum of CPU limits cannot exceed this value</li>
  <li>
<strong>limits.memory</strong>: sum of memory limits cannot exceed this value</li>
  <li>
<strong>requests.cpu</strong>: dtto for requests</li>
  <li>
<strong>requests.memory</strong>: dtto for requests</li>
</ul>

<p>Storage resource quota:</p>

<ul>
  <li>
<strong>requests.storage</strong>: total amount of requested storage across all persistent volume claims</li>
  <li>
<strong>persistentvolumeclaims</strong>: maximum number of persistent volume claims allowed in the namespace</li>
  <li>
<strong>.storageclass.storage.k8s.io/requests.storage</strong>: total amount of requested storage across all persistent volume claims associated wit the storage class name</li>
  <li>
<strong>.storageclass.storage.k8s.io/persistentvolumeclaims</strong>: maximum number of persistent volume claims allowed in the namespace that are associated with the storage class name</li>
  <li>
<strong>requests.ephemeral-storage</strong>: total amount of requested ephemeral storage across all pods in the namespace claims</li>
  <li>
<strong>limits.ephemeral-storage</strong>: total amount of limits for empeheral storage across all pods in the namespace claims.</li>
</ul>

<p>Object count quota:</p>

<ul>
  <li>
<strong>count/.</strong> for resources from non-core groups</li>
  <li>
<strong>count/</strong> for resources from the core group</li>
</ul>

<p>Some of these:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">count</span><span class="o">/</span><span class="n">persistentvolumeclaims</span>
<span class="n">count</span><span class="o">/</span><span class="n">services</span>
<span class="n">count</span><span class="o">/</span><span class="n">secrets</span>
<span class="n">count</span><span class="o">/</span><span class="n">configmaps</span>
<span class="n">count</span><span class="o">/</span><span class="n">replicationcontrollers</span>
<span class="n">count</span><span class="o">/</span><span class="n">deployments</span><span class="p">.</span><span class="n">apps</span>
<span class="n">count</span><span class="o">/</span><span class="n">replicasets</span><span class="p">.</span><span class="n">apps</span>
<span class="n">count</span><span class="o">/</span><span class="n">statefulsets</span><span class="p">.</span><span class="n">apps</span>
<span class="n">count</span><span class="o">/</span><span class="n">jobs</span><span class="p">.</span><span class="n">batch</span>
<span class="n">count</span><span class="o">/</span><span class="n">cronjobs</span><span class="p">.</span><span class="n">batch</span>
</code></pre></div></div>

<p>Example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="n">namespace</span> <span class="n">quota</span><span class="o">-</span><span class="n">example</span>
<span class="n">k</span> <span class="nb">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">ns</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">limit</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">k</span> <span class="n">describe</span> <span class="n">ns</span> <span class="n">quota</span><span class="o">-</span><span class="n">example</span>
<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">lab</span><span class="o">-</span><span class="mf">1.</span><span class="n">yml</span>
<span class="n">k</span> <span class="o">-</span><span class="n">n</span> <span class="n">quota</span><span class="o">-</span><span class="n">example</span> <span class="n">scale</span> <span class="n">deployment</span><span class="o">/</span><span class="n">example</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">5</span>
<span class="n">k</span> <span class="o">-</span><span class="n">n</span> <span class="n">quota</span><span class="o">-</span><span class="n">example</span> <span class="n">get</span> <span class="n">events</span>
<span class="n">k</span> <span class="o">-</span><span class="n">n</span> <span class="n">quota</span><span class="o">-</span><span class="n">example</span> <span class="n">get</span> <span class="n">pods</span>     <span class="c1"># ready
</span><span class="n">k</span> <span class="n">describe</span> <span class="n">ns</span> <span class="n">quota</span><span class="o">-</span><span class="n">example</span>     <span class="c1"># show current
</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">deployments</span> <span class="o">-</span><span class="n">n</span> <span class="n">quota</span><span class="o">-</span><span class="n">example</span> <span class="n">example</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">ns</span> <span class="n">quota</span><span class="o">-</span><span class="n">example</span>

<span class="c1"># count quota for pods
</span><span class="n">k</span> <span class="n">create</span> <span class="n">ns</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>
<span class="n">k</span> <span class="nb">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">limit</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">resourcequota</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>        <span class="c1"># REQUEST pods: 0/2
</span><span class="n">k</span> <span class="n">describe</span> <span class="n">ns</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>

<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">example</span><span class="p">.</span><span class="n">yml</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>                 <span class="c1"># READY 1/1
</span><span class="n">k</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span> <span class="n">scale</span> <span class="n">deployment</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">5</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>                 <span class="c1"># 2
</span><span class="n">k</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span> <span class="n">get</span> <span class="n">events</span>               <span class="c1"># FailedCreate ...
</span><span class="n">k</span> <span class="n">describe</span> <span class="n">ns</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>                 <span class="c1"># 2/2
</span></code></pre></div></div>

<h2 id="limit-range">Limit Range</h2>
<p>If a LimitRange object exists in a namespace, then any container created without the resource requests or limits configured will inherit these values from the limit range.</p>

<p>Example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">assign</span><span class="o">-</span><span class="n">limit</span><span class="o">-</span><span class="nb">range</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">limits</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>           <span class="c1"># define-limit created $NOW
</span><span class="n">k</span> <span class="n">describe</span> <span class="n">ns</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">limits</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span> <span class="n">define</span><span class="o">-</span><span class="n">limit</span>     <span class="c1"># only the limits
</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">deployments</span><span class="p">.</span><span class="n">apps</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span> <span class="n">nginx</span><span class="o">-</span><span class="mi">1</span> 
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span>                 <span class="c1"># 0
</span>
<span class="n">k</span> <span class="nb">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">example</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span> <span class="n">nginx</span><span class="o">-</span><span class="mi">1</span>        <span class="c1"># requests/limits inherited
</span>
<span class="n">k</span> <span class="n">delete</span> <span class="n">limitrange</span> <span class="o">-</span><span class="n">n</span> <span class="n">pods</span><span class="o">-</span><span class="n">quota</span><span class="o">-</span><span class="n">ns</span> <span class="n">define</span><span class="o">-</span><span class="n">limit</span>
</code></pre></div></div>

<h2 id="limiting-resources">Limiting resources</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[].</span><span class="n">resources</span><span class="p">.</span><span class="n">limits</span><span class="p">.</span><span class="n">cpu</span>
<span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[].</span><span class="n">resources</span><span class="p">.</span><span class="n">limits</span><span class="p">.</span><span class="n">memory</span>
<span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[].</span><span class="n">resources</span><span class="p">.</span><span class="n">limits</span><span class="p">.</span><span class="n">hugepages</span><span class="o">-</span>
<span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[].</span><span class="n">resources</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">cpu</span>
<span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[].</span><span class="n">resources</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">memory</span>
<span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[].</span><span class="n">resources</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">hugepages</span><span class="o">-</span>
</code></pre></div></div>

<p>CPU:</p>

<ul>
  <li>CPU unit is 1 core for cloud providers and 1 hyperthread for bare metal Intel processors</li>
  <li>.5 is half a core, or 500 m (mili-cores).</li>
  <li>Smallest addressable unit is 1m.</li>
</ul>

<p>Memory:</p>

<ul>
  <li>K/M/G/T/P/E suffix - 1000**N</li>
  <li>Ki/Mi/Gi/Ti/Pi/Ei - 1024**N</li>
</ul>

<p>Example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="n">ns</span> <span class="n">cpu</span><span class="o">-</span><span class="n">limit</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">ns</span>
<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">resource</span><span class="o">-</span><span class="n">limit</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">cpu</span><span class="o">-</span><span class="n">limit</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
<span class="n">k</span> <span class="n">describe</span> <span class="n">pods</span> <span class="n">frontend</span>

<span class="n">k</span> <span class="n">delete</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">cpu</span><span class="o">-</span><span class="n">limit</span> <span class="n">frontend</span>
</code></pre></div></div>

<p>If no CPU limit is specified and there is no <code class="language-python highlighter-rouge"><span class="n">LimitRange</span></code> object, the countainer will use all the available CPU resources on the node it is running.</p>

<h1 id="expose-containers-to-external-networks">Expose containers to external networks</h1>

<h2 id="kubectl-port-forwarding">kubectl port forwarding</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span> <span class="n">port</span><span class="o">-</span><span class="n">forward</span> <span class="n">nginx</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">80</span>
<span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8888</span>
</code></pre></div></div>

<h2 id="kubectl-expose">kubectl expose</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">nginx</span><span class="o">-</span><span class="n">lab</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">nginx</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">3</span> <span class="o">--</span><span class="n">dry</span><span class="o">-</span><span class="n">run</span><span class="o">=</span><span class="n">client</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span> <span class="o">&gt;</span> <span class="n">nginx</span><span class="o">-</span><span class="n">lab</span><span class="o">-</span><span class="mf">1.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">lab</span><span class="o">-</span><span class="mf">1.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">nginx</span><span class="o">-</span><span class="n">lab</span><span class="o">-</span><span class="mi">1</span>

<span class="n">k</span> <span class="n">expose</span> <span class="n">deployment</span> <span class="n">nginx</span><span class="o">-</span><span class="n">lab</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="nb">type</span><span class="o">=</span><span class="n">NodePort</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">services</span>
<span class="c1"># ...
# nginx-lab-1   NodePort    10.108.128.242   &lt;none&gt;        80:31060/TCP   3s
</span><span class="n">k</span> <span class="n">describe</span> <span class="n">svc</span> <span class="n">nginx</span><span class="o">-</span><span class="n">lab</span><span class="o">-</span><span class="mi">1</span>  <span class="c1"># to get more info about the service
</span></code></pre></div></div>

<h2 id="ingress">Ingress</h2>
<ul>
  <li>provide an externally visible URL to the service</li>
  <li>load balance traffic</li>
  <li>terminates SSL</li>
  <li>provide name-based virtual hosting</li>
</ul>

<p>Only creating an Ingress resource has no efect. You need to select and deploy one to your cluster (many implementations, e.g. nginx or HAProxy).</p>

<p><a href="Examples">Examples</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">minikube</span> <span class="n">version</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">nodes</span>

<span class="n">minikube</span> <span class="n">addons</span> <span class="n">enable</span> <span class="n">ingress</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>   <span class="c1"># ingress-nginx-*
</span></code></pre></div></div>

<h3 id="configure-ingress-using-host">Configure Ingress using Host</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">nginx</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">nginx</span>
<span class="n">k</span> <span class="n">scale</span> <span class="n">deployment</span> <span class="n">nginx</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">3</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">deployments</span>

<span class="n">k</span> <span class="n">expose</span> <span class="n">deployment</span> <span class="n">nginx</span> <span class="o">--</span><span class="nb">type</span><span class="o">=</span><span class="n">NodePort</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">service</span>
<span class="n">minikube</span> <span class="n">service</span> <span class="n">nginx</span> <span class="o">--</span><span class="n">url</span>        <span class="c1"># or `ip a`
# add this to /etc/hosts as host.example.com
</span><span class="n">k</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">rule</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">ingress</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">ing</span> <span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span> <span class="o">-</span><span class="n">o</span> <span class="n">yam</span>
<span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">host</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span>
</code></pre></div></div>

<h3 id="configure-ingress-using-path">Configure Ingress using Path</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">web2</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">nginx</span>
<span class="n">k</span> <span class="n">scale</span> <span class="n">deployment</span> <span class="n">web2</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">3</span>
<span class="n">k</span> <span class="n">expose</span> <span class="n">deployment</span> <span class="n">web2</span> <span class="o">--</span><span class="nb">type</span><span class="o">=</span><span class="n">NodePort</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">svc</span>   <span class="c1"># +web2
</span><span class="n">minikube</span> <span class="n">service</span> <span class="n">web2</span> <span class="o">--</span><span class="n">url</span>
<span class="c1"># vi nginx-ingress-rule.yml
</span><span class="n">k</span> <span class="nb">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">rule</span><span class="p">.</span><span class="n">yml</span>
<span class="n">k</span> <span class="n">get</span> <span class="n">ing</span> <span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span>
<span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">host</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">v2</span>
</code></pre></div></div>

<!--
    vim:spell spelllang=en
-->


          </div>
          <footer class="c-article__footer">
            <p>
              
                <span class="c-tag">it</span>
              
            </p>
          </footer>
        </article>
      </div>
    </main>
  </body>
</html>
